<script lang="ts">
  import { storage } from "$lib/states/storage.svelte";
  import Sidebar from "$lib/components/Sidebar.svelte";
  import ImportIcon from "$lib/icons/ExportIcon.svelte";
  import ExportIcon from "$lib/icons/ImportIcon.svelte";
  import SettingsIcon from "$lib/icons/SettingsIcon.svelte";
  import Modal from "$lib/components/reusable/Modal.svelte";
  import Settings from "$lib/components/Settings.svelte";
  import { mkConfig, generateCsv, download } from "export-to-csv";
  import Papa from "papaparse";

  let isSidebarOpen = $state(false);
  let isSettingsOpen = $state(false);

  function exportToCSV() {
    const csvConfig = mkConfig({
      useKeysAsHeaders: true,
      filename: "products",
    });
    const csv = generateCsv(csvConfig)(
      storage.persistentProducts.get().values().toArray(),
    );
    download(csvConfig)(csv);
  }

  function importFromCSV() {
    const input = document.createElement("input") as HTMLInputElement;
    input.type = "file";
    input.accept = ".csv";
    input.style.display = "none";
    input.addEventListener("change", (e: any) => {
      Papa.parse(e.target.files[0], {
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const products = results.data as Product[];
          storage.persistentProducts.set(
            new Map(products.map((obj) => [obj.title, obj])),
          );
        },
      });
    });
    input.click();
    input.remove();
  }
</script>

<header
  class="relative bg-gradient-to-r from-purple-600 via-purple-700 to-indigo-600 text-white p-4"
>
  <div class="flex items-center justify-between">
    <h1 class="text-xl font-bold tracking-tight">Calories Calculator</h1>

    <button
      onclick={() => (isSidebarOpen = true)}
      class="p-1 rounded-full bg-white/10 hover:bg-white/20 transition-colors duration-200 backdrop-blur-sm"
      aria-label="Open menu"
    >
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
        <circle cx="12" cy="5" r="2" />
        <circle cx="12" cy="12" r="2" />
        <circle cx="12" cy="19" r="2" />
      </svg>
    </button>
  </div>
  <Sidebar
    bind:sidebarOpen={isSidebarOpen}
    items={[
      {
        title: "Import",
        description: "Import food data",
        className: "bg-blue-500",
        Icon: ImportIcon,
        onClick: importFromCSV,
      },
      {
        title: "Export",
        description: "Export food data",
        className: "bg-green-500",
        Icon: ExportIcon,
        onClick: exportToCSV,
      },
      {
        title: "Settings",
        description: "Configure application",
        className: "bg-orange-500",
        Icon: SettingsIcon,
        onClick: () => {
          isSettingsOpen = true;
        },
      },
    ]}
  />
  <Modal bind:visible={isSettingsOpen} title="Settings">
    {#snippet content()}
      <Settings />
    {/snippet}
  </Modal>
</header>
